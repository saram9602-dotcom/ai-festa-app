<!doctype html>
<html lang="ko">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AI 소설 생성기</title>
<style>
:root{--bg:#0a0f1a;--card:#0f172a;--text:#f8fafc;--muted:#cbd5e1;--border:#334155;--accent:#8b5cf6}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif}
.wrap{max-width:900px;margin:0 auto;padding:18px}
h1{display:flex;gap:10px;align-items:center}
.card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));border:1px solid var(--border);border-radius:14px;padding:14px;margin-top:12px}
label{display:block;margin-top:8px;color:var(--muted)} input{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0b1320;color:var(--text)}
.btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#0b1320;color:#fff;cursor:pointer}
.btn.primary{background:linear-gradient(180deg,rgba(139,92,246,.9),rgba(139,92,246,.75))}
.story{min-height:300px;border:1px dashed #3b475a;border-radius:12px;background:#0b1320;padding:14px;white-space:pre-wrap;line-height:1.9;font-size:18px;margin-top:10px}
.proc{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px}
.step{padding:8px;border-radius:10px;border:1px solid #3b475a;background:#0b1320}
.bar{height:8px;border-radius:999px;background:#0f172a;border:1px solid #334155;overflow:hidden}
.fill{height:100%;width:0;background:linear-gradient(90deg,#22d3ee,#8b5cf6)}
.small{font-size:12px;color:var(--muted)}
</style>
<body>
<div class="wrap">
  <h1>AI 소설 생성기</h1>
  <div class="card">
    <label>주제</label>
    <input id="topic" placeholder="예: 미술관 관람 / 도자기 만들기 / 자유 주제 등">
    <label>무엇을 보거나 만들었나요?</label><input id="a1" placeholder="예: 파란색이 크게 번진 그림을 봤어요.">
    <label>누구와 함께 했나요?</label><input id="a2" placeholder="예: 친구와 함께 관람했어요.">
    <label>가장 재미있었던 순간은?</label><input id="a3" placeholder="예: 종이를 떼는 순간이 가장 신기했어요.">
    <label>돌아올 때 마음은?</label><input id="a4" placeholder="예: 마음이 차분해졌어요.">
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn" id="auto">예시로 자동 완성</button>
      <button class="btn primary" id="go">소설 생성</button>
    </div>
    <div class="small" style="margin-top:6px">※ 생성이 멈추면 새로고침 후 다시 시도하세요.</div>
    <div class="proc" id="proc" style="display:none">
      <div class="step"><div class="small">아이디어</div><div class="bar"><div class="fill" id="p1"></div></div></div>
      <div class="step"><div class="small">장면</div><div class="bar"><div class="fill" id="p2"></div></div></div>
      <div class="step"><div class="small">감정선</div><div class="bar"><div class="fill" id="p3"></div></div></div>
      <div class="step"><div class="small">문장</div><div class="bar"><div class="fill" id="p4"></div></div></div>
    </div>
  </div>
  <div class="card">
    <div class="story" id="story"></div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn" id="copy">복사하기</button>
      <button class="btn" id="save">TXT 다운로드</button>
    </div>
  </div>
</div>
<script>
const EX = ["파란색이 크게 번진 그림을 봤어요.","친구와 함께 관람했어요.","종이를 떼는 순간이 가장 신기했어요.","마음이 차분해졌어요."];
const $ = id=>document.getElementById(id);

function typewriter(el, text, speed=12){
  let i=0; return new Promise(res=>{(function tick(){
    const step=2; el.textContent += text.slice(i,i+step); i+=step;
    if(i<text.length) setTimeout(tick, speed); else res();
  })()});
}

async function callStory(topic, answers, onChunk){
  const res = await fetch("/api/story",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({topic,answers})});
  if(!res.ok){onChunk("[오류] "+await res.text());return}
  const ctype=(res.headers.get("content-type")||"").toLowerCase();
  if(!ctype.includes("text/event-stream")||!res.body){
    const raw=await res.text(); try{const j=JSON.parse(raw);onChunk(j.output_text||j.text||raw)}catch{onChunk(raw)}; return;
  }
  const reader=res.body.getReader(); const decoder=new TextDecoder("utf-8"); let buf="";
  while(true){
    const {value,done}=await reader.read(); if(done) break;
    buf += decoder.decode(value,{stream:true});
    const lines = buf.split("\n"); buf = lines.pop() || "";
    for(const line of lines){
      const s=line.trim(); if(!s.startsWith("data:")) continue;
      const payload=s.slice(5).trim(); if(payload==="[DONE]") continue;
      try{ const o=JSON.parse(payload); const t=o.output_text??o.delta??""; if(t) onChunk(t); }catch{}
    }
  }
  if(buf.startsWith("data:")){
    const payload=buf.slice(5).trim(); if(payload && payload!=="[DONE]"){
      try{ const o=JSON.parse(payload); const t=o.output_text??o.delta??""; if(t) onChunk(t);}catch{}
    }
  }
}

$("auto").onclick=()=>{$("a1").value=EX[0];$("a2").value=EX[1];$("a3").value=EX[2];$("a4").value=EX[3];$("topic").value="미술관 관람"};

$("go").onclick=async()=>{
  const topic=$("topic").value.trim()||"자유 주제";
  const answers=[$("a1").value, $("a2").value, $("a3").value, $("a4").value];
  if(answers.filter(v=>v && v.trim()).length<4){alert("네 문장을 모두 채워주세요. ‘예시로 자동 완성’을 눌러도 됩니다.");return}
  $("proc").style.display="grid"; ["p1","p2","p3","p4"].forEach(id=>$(id).style.width="0");
  const story=$("story"); story.textContent=""; const para=document.createElement("p"); para.textContent="　"; story.appendChild(para);
  setTimeout(()=>$("p1").style.width="100%",200); setTimeout(()=>$("p2").style.width="100%",700); setTimeout(()=>$("p3").style.width="100%",1200);
  const q=[]; let typing=false;
  async function onChunk(t){ q.push(t); if(typing) return; typing=true; while(q.length){await typewriter(para,q.shift(),10); story.scrollTop=story.scrollHeight;} typing=false; }
  await callStory(topic, answers, onChunk);
  setTimeout(()=>$("p4").style.width="100%",300);
  setTimeout(()=>{$("proc").style.display="none"; ["p1","p2","p3","p4"].forEach(id=>$(id).style.width="0")},800);
};

$("copy").onclick=()=>navigator.clipboard.writeText($("story").textContent.trim());
$("save").onclick=()=>{const a=document.createElement("a");a.href=URL.createObjectURL(new Blob([$("story").textContent.trim()],{type:"text/plain;charset=utf-8"}));a.download="내 소설.txt";a.click();URL.revokeObjectURL(a.href);};
</script>
</html>
